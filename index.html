<!DOCTYPE html>
<html lang="">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .green { color: green; }
    .yellow { color: goldenrod; }
    .red { color: red; }
    footer {
      background-color: #dddddd;
      color: #000000;
      text-align: center;
      padding: 2px;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
    }
    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    html * {
      font-family: Calibri, Helvetica, Arial, sans-serif;
    }

  </style>
  <head>
    <title>chemicle</title>
    <h1 style="font-family: Calibri, Helvetica, Arial, sans-serif; text-align: center;
      padding: 2px; position: static">chemicle</h1>
  </head>
  <script type="text/JavaScript">

    function splitOrganicString(input) {
      // Validity Checker and regex generated by ChatGPT, with prompts, fixes and major modifications made by self
      // Define the valid organic chemical parts
      const validParts = [
        "meth", "eth", "prop", "but", "pent", "hex", "hept", "oct", "non", "dec", // Prefixes for chain lengths
        "yl", "ane", "ene", "yne",                                                // Suffixes for types of hydrocarbons
        "di", "tri", "tetra",                                                     // Multipliers for side chains
        "tert-", "t-", "sec-",                                                    // Butyl prefixes
        "iso", "cyclo", "poly", "benz",                                           // Miscellaneous prefixes
        "fluoro", "chloro", "bromo", "iodo",                                      // Halides
        "oxy", "hydroxy", "amino", "oxo", "anol", "anal", "anone", "anoic",       // Functional groups
        "acid", "oate", "anoate", "ether",  "nitrile",                            // More functional groups
        "1", "2", "3", "4", "5", "6", "7", "8", "9", ",", "-",                    // Positions (1-9)
        "an", "ol", "one", "a",                                                   // "Cool" spelling (e.g. propan-2-ol)
      ];

      // Remove whitespace from the input
      input = input.replace(/\s+/g, '').toLowerCase();

      // Result array to store parts
      const result = [];

      // Define a helper function to find the longest matching part from the input
      function matchPart(input) {
        for (let part of validParts) {
          if (input.startsWith(part)) {
            return part;
          }
        }
        return null;  // No valid part found
      }

      // Loop through the input to match parts
      while (input.length > 0) {
        const matchedPart = matchPart(input);

        if (!matchedPart) {
          // No valid part matched; return false
          return false;
        }

        // Add the matched part to the result array
        result.push(matchedPart);

        // Remove the matched part from the beginning of the input
        input = input.slice(matchedPart.length);
      }

      // Return the list of matched parts
      return result;
    }


    // Random selection for ids based on date
    function getDailyId(maxValue) {
      // Generated by ChatGPT, prompts and modifications made by self

      // Create a Date object for December 1st, 2024, 5:00 AM GMT
      const dec1st5AM = new Date(Date.UTC(2024, 11, 1, 5, 0, 0, 0)); // 11 = December (months are 0-indexed)

      // Get the current date and time in GMT
      const now = new Date();

      // Calculate the difference in milliseconds
      const diffInMs = now - dec1st5AM;

      // Convert milliseconds to days (1 day = 24 * 60 * 60 * 1000 ms)
      let diffInDays = Math.floor(diffInMs / (24 * 60 * 60 * 1000));

      function random(seed, hasChecked = false) {
        let t = (seed ^ 0xDEADBEEF) + (seed << 3);
        t = (t ^ (t >>> 16)) * 0x85EBCA6B;
        t = (t ^ (t >>> 13)) * 0xC2B2AE35;
        t = t ^ (t >>> 16);

        // Quick check to ensure no repeats. Still a very small chance of a repeat on the day after an avoided repeat, but this occurring is very unlikely.
        if(!hasChecked && t === random(seed-1, true)) {
          // Adds large prime to ensure different value
          return t + 999331;
        }
        return t;
      }

      return (Math.abs(random(diffInDays)) % maxValue) + 1;
    }

    const maxValue = 25;

    let id;
    let trueMolecule;
    let formula;
    let doneLoading = false;
    let result = getDailyId(maxValue)
    id = "alkane-" + (result+2).toString().padStart(3, "0");
    console.log(id);
    fetch("assets/" + id + "/name.txt")
            .then((res) => res.text())
            .then((text) => {
              const splitString = text.split(", ");
              //console.log(splitString);
              trueMolecule = splitString[0].replaceAll("\"", "");
              formula = splitString[1].replaceAll("\"", "");
              doneLoading = true;
            })
            .catch((e) => console.error(e));


    let curSplit = "";
    let curGuessNum = 1;

    let formulaButton;
    let formulaDiv;
    let lineButton;
    let lineImage;
    let lewisButton;
    let lewisImage;

    document.addEventListener("DOMContentLoaded", async function () {
      while (!doneLoading) {
        await new Promise(r => setTimeout(r, 10))
      }

      formulaButton = document.getElementById('formulaButton');

      formulaDiv = document.getElementById('formula');
      formulaDiv.innerHTML = "Formula = " + formula;

      lineButton = document.getElementById('lineButton');
      lineImage = document.getElementById('line');
      lineImage.src = "assets/" + id + "/line.png";

      lewisButton = document.getElementById('lewisButton');
      lewisImage = document.getElementById('lewis');
      lewisImage.src = "assets/" + id + "/lewis.png";

      formulaButton.addEventListener('click', () => {
        toggleVisibility(formulaButton, formulaDiv, "Chemical Formula", false)
      });

      lineButton.addEventListener('click', () => {
        toggleVisibility(lineButton, lineImage, "Line Structure")
      });

      lewisButton.addEventListener('click', () => {
        toggleVisibility(lewisButton, lewisImage, "Lewis Structure")
      });

      if (getCookie("curGuessNum") !== "" && getCookie("curGuessNum") > 1) {
        let guessNum = getCookie("curGuessNum");
        for (let i = 1; i < guessNum; i++) {
          curSplit = getCookie("guess" + i).split(',').map(item => item === "" ? "," : item).filter((item, index, array) => item !== ',' || array[index - 1] !== ',');

          console.log("Updating guess" + i + " to " + curSplit)
          showGuess(true);
        }
      }
    });



    function toggleVisibility(button, element, name, isImage = true) {
      if(isImage) {
        if (element.style.display === 'none' || element.style.display === '') {
          element.style.display = 'block'; // Show the image
          button.innerHTML = "Hide " + name;
        } else {
          element.style.display = 'none'; // Hide the image
          button.innerHTML = "Show " + name;
        }
      }
      else {
        if (element.hidden === true) {
          element.hidden = false; // Show the image
          button.innerHTML = "Hide " + name;
        } else {
          element.hidden = true; // Hide the image
          button.innerHTML = "Show " + name;
        }
      }

    }

    function handleSubmit() {
      const inputText = document.getElementById("guessInput").value;
      const output = splitOrganicString(inputText);
      if (output === false) {
        document.getElementById("validWarning").hidden = false;
        return false;
      } else {
        document.getElementById("validWarning").hidden = true;
        curSplit = output;
        showGuess();
        return false;
      }
    }

    function displayColoredText(input, stored, num) {
      // Code generated by ChatGPT, prompt and modifications made by self

      let outputDiv;
      try {
        outputDiv = document.getElementById("guess" + num);
      }
      catch(e) {
        console.log("The output div guess + " + num + "does not exist")
        return;
      }
      outputDiv.innerHTML = ''; // Clear any existing content
      const matchedStored = Array(stored.length).fill(false); // Tracks matches in Stored array

      // Step 1: Exact matches (green)
      const results = input.map((item, index) => {
        if (item === stored[index]) {
          matchedStored[index] = true; // Mark exact match in Stored
          return {text: item, colorClass: 'green'};
        }
        return {text: item, colorClass: null}; // Placeholder for later steps
      });

      // Step 2: Non-index matches (yellow)
      results.forEach(result => {
        if (result.colorClass === null) { // Only process items not already green
          const storedIndex = stored.findIndex((item, i) => item === result.text && !matchedStored[i]);
          if (storedIndex !== -1) { // If there's an unmatched stored item
            matchedStored[storedIndex] = true; // Mark this stored item as matched
            result.colorClass = 'yellow';
          } else {
            result.colorClass = 'red'; // No match found in Stored
          }
        }
      });

      // Step 3: Display the results
      results.forEach(result => {
        const span = document.createElement('span');
        span.className = result.colorClass;
        span.textContent = result.text + ' ';
        outputDiv.appendChild(span);
      });

      // Step 4: Determine length message
      const lengthMessage = document.createElement('div');
      if (input.length < stored.length) {
        lengthMessage.textContent = 'too short';
      } else if (input.length > stored.length) {
        lengthMessage.textContent = 'too long';
      } else {
        lengthMessage.textContent = 'correct length';
      }
      outputDiv.appendChild(lengthMessage);
    }

    function showGuess(fromCookies = false){
      displayColoredText(curSplit, splitOrganicString(trueMolecule), curGuessNum)
      if(!fromCookies) {
        setCookie("guess" + curGuessNum, curSplit)
      }
      // Clear input box
      document.getElementById("guessInput").value = "";

      // Increment guess number
      curGuessNum++;
      if(!fromCookies) {
        setCookie("curGuessNum", curGuessNum)
      }

      // Show corresponding hint
      if(curGuessNum === 2) {
        formulaButton.style.display = 'block';
      }
      else if(curGuessNum === 3) {
        lineButton.style.display = 'block';
      }
      else if(curGuessNum === 4) {
        lewisButton.style.display = 'block';
      }

      // Add new div
      const newDiv = document.createElement("div");
      newDiv.id = "guess" + curGuessNum;
      newDiv.style.setProperty("text-align", "center");
      const lastDiv = document.getElementById("guess" + (curGuessNum - 1));
      lastDiv.parentNode.insertBefore(newDiv, lastDiv.nextSibling);
    }

    // Modified from https://www.w3schools.com/js/js_cookies.asp
    function setCookie(cname, cvalue, expire = true) {
      if(expire === true) {
        const now = new Date();

        // Create a new Date object for the next 5 AM GMT
        let next5AM = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 5, 0, 0, 0));

        // If it's already past 5 AM GMT today, move to the next day
        if (now >= next5AM) {
          next5AM = new Date(next5AM.getTime() + 24 * 60 * 60 * 1000);
        }
        let expires = "expires="+ next5AM.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;SameSite=Strict";
      }
      else {
        document.cookie = cname + "=" + cvalue + ";path=/;SameSite=Strict";
      }

    }

    // Used from https://www.w3schools.com/js/js_cookies.asp
    function getCookie(cname) {
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for(let i = 0; i <ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) === 0) {
          console.log("Cookie: " + cname + ", value: " + c.substring(name.length, c.length))
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }


  </script>
  <body>
    <div id="guess1" style="text-align: center;"></div>
    <form onsubmit="return handleSubmit();"  style="text-align: center; padding: 1%">

      <label for="guessInput"></label>
      <input type="text"
             id="guessInput"
             name="guessInput"
             required minlength="4"
             maxlength="64"
             size="15">
      <input type="submit"
             name="submitButton"
             value="Submit">
    </form>
    <p id="validWarning" hidden="hidden" style="color:red;text-align: center;">The input is invalid. Please check spelling and make sure your guess is a real molecule.</p>

    <button id="formulaButton" style="text-align: center; display: none" class="center" >Show Chemical Formula</button>
    <div style="padding: 0.6%"></div>
    <div id="formula" style="text-align: center" hidden="hidden"></div>
    <div style="padding: 0.6%"></div>
    <button id="lineButton" style="text-align: center; display: none" class="center">Show Line Structure</button>
    <div style="padding: 0.6%"></div>
    <img id="line" src="" alt="Line Structure of Molecule" class="center" style="width:10%; border: 2px solid; display: none" >
    <div style="padding: 0.6%"></div>
    <button id="lewisButton" style="text-align: center; display: none" class="center" >Show Lewis Structure</button>
    <div style="padding: 0.6%"></div>
    <img id="lewis" src="" alt="Lewis Structure of Molecule" class="center" style="width:10%; border: 2px solid; display: none" >

  </body>


  <footer>
    <p>This site uses locally stored cookies to maintain site functionality. No information is stored, sent, or communicated with any server, nor is any personal or private information collected.</p>
  </footer>
</html>

