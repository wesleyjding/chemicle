<!DOCTYPE html>
<html lang="">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .green { color: green; }
    .yellow { color: goldenrod; }
    .red { color: red; }
    footer {
      background-color: #dddddd;
      color: #000000;
      text-align: center;
      padding: 2px;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
    }
    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    html * {
      font-family: Calibri, Helvetica, Arial, sans-serif;
    }

  </style>
  <head>
    <title>chemicle</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon-light.png" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/x-icon" href="assets/favicon-dark.png" media="(prefers-color-scheme: dark)">
  </head>
  <script type="text/JavaScript">
    // Organic Chemical Type (type, max)
    class oct {
      constructor(type, max) {
        this._enabled = true;
        this._type = type;
        this._max = max;
      }

      get type() {
        return this._type;
      }

      get max() {
        return this._max;
      }

      get enabled() {
        return this._enabled;
      }

      set enabled(value) {
        this._enabled = value;
      }
    }

    let idNum;

    let moleculeType;
    let moleculeId;

    let trueMoleculeName;
    let trueMoleculeFormula;

    let doneLoading = false;

    let curSplit = "";
    let curGuessNum = 1;

    let formulaButton;
    let formulaDiv;
    let lineButton;
    let lineImage;
    let lewisButton;
    let lewisImage;

    document.addEventListener("DOMContentLoaded", async function () {
      generateId();
      while (!doneLoading) {
        await new Promise(r => setTimeout(r, 10))
      }
      reloadAssets();
      updateFromStorage();
    });

    function generateId(moleculeNum = 1) {
      const typeList = [new oct("alkane", 71), new oct("alkene", 33), new oct("alkyne", 33), new oct("alcohol", 12),
        new oct("ketone", 13), new oct("carboxylicAcid", 29), new oct("aldehyde", 28), new oct("ether", 12),
        new oct("ester", 18), new oct("amine", 32), new oct("amide", 12), new oct("nitrile", 4),
        new oct("misc", 7)];

      let totalMax = 0;
      for (let i = 0; i < typeList.length; i++) {
        if(typeList[i].enabled === true) {
          totalMax += typeList[i].max;
        }
      }

      // Random selection for ids based on date
      function getDailyIdNum(maxValue, moleculeN = 1) {
        function dailyRandom() {
          // Partly generated by ChatGPT

          // Create a Date object for December 1st, 2024, 5:00 AM GMT
          const dec1st5AM = new Date(Date.UTC(2024, 11, 1, 5, 0, 0, 0)); // 11 = December (months are 0-indexed)

          // Get the current date and time in GMT
          const now = new Date();

          // Calculate the difference in milliseconds
          const diffInMs = now - dec1st5AM;

          // Convert milliseconds to days (1 day = 24 * 60 * 60 * 1000 ms)
          let diffInDays = Math.floor(diffInMs / (24 * 60 * 60 * 1000));

          // Deterministic random algorithm
          function random(seed) {
            let t = (seed ^ 0xEFC5DAF8) + (seed << 3);
            t = (t ^ (t >>> 16)) * 0x42EDBF1C;
            t = (t ^ (t >>> 13)) * 0xD9AAB462;
            t = t ^ (t >>> 16);
            return t;
          }

          return Math.abs(random(diffInDays));
        }
        let d = dailyRandom();
        let add = (moleculeN - 1) * Math.floor(Math.pow(d, 0.5));
        return (d + add) % maxValue + 1;
      }

      idNum = getDailyIdNum(totalMax, moleculeNum);
      function checkWithin (max, type) {
        if(idNum <= max) {
          moleculeType = type;
          return true;
        }
        else {
          idNum -= max;
          return false;
        }
      }

      for (let i = 0; i < typeList.length; i++) {
        if (typeList[i].enabled === true) {
          if (checkWithin(typeList[i].max, typeList[i].type)) {
            break;
          }
        }
      }
      moleculeId = moleculeType + "-" + (idNum).toString().padStart(3, "0");
      console.log(moleculeId);

      fetch("assets/" + moleculeId + "/name.txt")
              .then((res) => res.text())
              .then((text) => {
                const splitString = text.split(", ");
                //console.log(splitString);
                trueMoleculeName = splitString[0].replaceAll("\"", "");
                trueMoleculeFormula = splitString[1].replaceAll("\"", "");
                trueMoleculeFormula = trueMoleculeFormula.replaceAll(/(\d+)/g, '<sub>$1</sub>');
                doneLoading = true;
              })
              .catch((e) => console.error(e));
    }

    function reloadAssets() {
      formulaButton = document.getElementById('formulaButton');

      formulaDiv = document.getElementById('formula');
      formulaDiv.innerHTML = "Formula = " + trueMoleculeFormula;

      lineButton = document.getElementById('lineButton');
      lineImage = document.getElementById('line');
      lineImage.src = "assets/" + moleculeId + "/line.png";

      lewisButton = document.getElementById('lewisButton');
      lewisImage = document.getElementById('lewis');
      lewisImage.src = "assets/" + moleculeId + "/lewis.png";

      formulaButton.addEventListener('click', () => {
        toggleVisibility(formulaButton, formulaDiv, "Chemical Formula", false)
      });

      lineButton.addEventListener('click', () => {
        toggleVisibility(lineButton, lineImage, "Line Structure")
      });

      lewisButton.addEventListener('click', () => {
        toggleVisibility(lewisButton, lewisImage, "Lewis Structure")
      });
    }

    function updateFromStorage() {
      if (getStorage("curGuessNum") !== "" && getStorage("curGuessNum") > 1) {
        let guessNum = getStorage("curGuessNum");
        for (let i = 1; i < guessNum; i++) {
          curSplit = getStorage("guess" + i).split(',').map(item => item === "" ? "," : item).filter((item, index, array) => item !== ',' || array[index - 1] !== ',');

          console.log("Updating guess" + i + " to " + curSplit)
          showGuess(true);
        }
      }
    }

    function toggleVisibility(button, element, name, isImage = true) {
      if(isImage) {
        if (element.style.display === 'none' || element.style.display === '') {
          element.style.display = 'block'; // Show the image
          button.innerHTML = "Hide " + name;
        } else {
          element.style.display = 'none'; // Hide the image
          button.innerHTML = "Show " + name;
        }
      }
      else {
        if (element.hidden === true) {
          element.hidden = false; // Show the image
          button.innerHTML = "Hide " + name;
        } else {
          element.hidden = true; // Hide the image
          button.innerHTML = "Show " + name;
        }
      }

    }

    function handleSubmit() {
      const inputText = document.getElementById("guessInput").value;
      const output = splitOrganicString(inputText);
      if (output === false) {
        document.getElementById("validWarning").hidden = false;
        return false;
      } else {
        document.getElementById("validWarning").hidden = true;
        curSplit = output;
        showGuess();
        return false;
      }
    }

    function splitOrganicString(input) {
      // Validity Checker and regex generated by ChatGPT, with prompts, fixes and major modifications made by self
      // Define the valid organic chemical parts
      const validParts = [
        "yl", "ane", "ene", "yne",                                                // Suffixes for types of hydrocarbons
        "di", "tri", "tetra",                                                     // Multipliers for side chains
        "tert-", "sec-",                                                          // Butyl prefixes
        "iso", "cyclo", "poly", "benz", "form", "acet",                           // Miscellaneous prefixes
        "fluoro", "chloro", "bromo", "iodo",                                      // Halides
        "oxy", "hydroxy", "amine", "oxo", "anol", "anal", "anone", "anoic",       // Functional groups
        "acid", "oate", "anoate", "ether",  "nitrile",                            // More functional groups
        "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", ",", "-", "(", ")",     // Positions (1-9)
        "meth", "eth", "prop", "but", "pent", "hex", "hept", "oct", "non", "dec", // Standard prefixes for chain lengths
        "an", "ol", "one", "ic", "ate", "a", "en", "yn", "o"                      // Misc suffixes for compact spelling
      ];

      // Remove whitespace from the input
      input = input.replace(/\s+/g, '').toLowerCase();

      // Result array to store parts
      const result = [];

      // Define a helper function to find the longest matching part from the input
      function matchPart(input) {
        for (let part of validParts) {
          if (input.startsWith(part)) {
            return part;
          }
        }
        return null;  // No valid part found
      }

      // Loop through the input to match parts
      while (input.length > 0) {
        const matchedPart = matchPart(input);

        if (!matchedPart) {
          // No valid part matched; return false
          return false;
        }

        // Add the matched part to the result array
        result.push(matchedPart);

        // Remove the matched part from the beginning of the input
        input = input.slice(matchedPart.length);
      }

      // Return the list of matched parts
      return result;
    }

    function displayColoredText(input, stored, num) {
      // Code generated by ChatGPT, prompt and modifications made by self

      let outputDiv;
      try {
        outputDiv = document.getElementById("guess" + num);
      }
      catch(e) {
        console.log("The output div guess + " + num + "does not exist")
        return;
      }
      outputDiv.innerHTML = ''; // Clear any existing content
      const matchedStored = Array(stored.length).fill(false); // Tracks matches in Stored array

      // Step 1: Exact matches (green)
      const results = input.map((item, index) => {
        if (item === stored[index]) {
          matchedStored[index] = true; // Mark exact match in Stored
          return {text: item, colorClass: 'green'};
        }
        return {text: item, colorClass: null}; // Placeholder for later steps
      });

      // Step 2: Non-index matches (yellow)
      results.forEach(result => {
        if (result.colorClass === null) { // Only process items not already green
          const storedIndex = stored.findIndex((item, i) => item === result.text && !matchedStored[i]);
          if (storedIndex !== -1) { // If there's an unmatched stored item
            matchedStored[storedIndex] = true; // Mark this stored item as matched
            result.colorClass = 'yellow';
          } else {
            result.colorClass = 'red'; // No match found in Stored
          }
        }
      });

      // Step 3: Display the results
      results.forEach(result => {
        const span = document.createElement('span');
        span.className = result.colorClass;
        span.textContent = result.text + ' ';
        outputDiv.appendChild(span);
      });

      // Step 4: Determine length message
      const lengthMessage = document.createElement('div');
      if (input.length < stored.length) {
        lengthMessage.textContent = 'too short';
      } else if (input.length > stored.length) {
        lengthMessage.textContent = 'too long';
      } else {
        lengthMessage.textContent = 'correct length';
      }
      lengthMessage.setAttribute("style", "padding-bottom: 0.2%");
      outputDiv.appendChild(lengthMessage);
    }

    function showGuess(fromStorage = false){
      displayColoredText(curSplit, splitOrganicString(trueMoleculeName), curGuessNum)
      if(!fromStorage) {
        setStorage("guess" + curGuessNum, curSplit)
      }
      // Clear input box
      document.getElementById("guessInput").value = "";

      // Increment guess number
      if(curGuessNum <= 20) {
        curGuessNum++;
        // Add new div
        const newDiv = document.createElement("div");
        newDiv.id = "guess" + curGuessNum;
        newDiv.style.setProperty("text-align", "center");
        const lastDiv = document.getElementById("guess" + (curGuessNum - 1));
        lastDiv.parentNode.insertBefore(newDiv, lastDiv.nextSibling);
      }

      if(!fromStorage) {
        setStorage("curGuessNum", curGuessNum)
      }

      // Show corresponding hint
      if(curGuessNum === 2) {
        formulaButton.style.display = 'block';
      }
      else if(curGuessNum === 3) {
        lineButton.style.display = 'block';
      }
      else if(curGuessNum === 4) {
        lewisButton.style.display = 'block';
      }
    }

    function setStorage (id, value, expire = true) {
      if(expire) {
        const now = new Date();

        // Create a new Date object for 5 AM today
        let next5AM = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 5, 0, 0, 0));

        // If it's already past 5 AM GMT today, move to the next day
        if (now >= next5AM) {
          next5AM = new Date(next5AM.getTime() + 24 * 60 * 60 * 1000);
        }
        let expires = "expires="+ next5AM;
        localStorage.setItem(id, value + expires);
      }
      else {
        localStorage.setItem(id, value);
      }
    }

    function getStorage (id) {
      let out = localStorage.getItem(id);
      if(!out) {
        return "";
      }

      out = out.split("expires=")
      if(out.length === 1) { // no expiry
        return out[0];
      }
      else {
        let d = new Date(Math.round(out[1]));
        let now = Date.now();
        if(now >= d) {
          localStorage.removeItem(id);
          return "";
        }
        else {
          return out[0];
        }
      }
    }
  </script>

  <body>
    <h1 style="text-align: center;
      padding: 0.1%; position: static; font-size: xx-large; "><b>chemicle</b></h1>
    <div id="guess1" style="text-align: center;"></div>
    <form onsubmit="return handleSubmit();"  style="text-align: center; padding: 1%">

      <label for="guessInput"></label>
      <input type="text"
             id="guessInput"
             name="guessInput"
             required minlength="4"
             maxlength="40"
             size="15">
      <input type="submit"
             name="submitButton"
             value="Submit">
    </form>
    <p id="validWarning" hidden="hidden" style="color:red;text-align: center;">The input is invalid. Please check spelling and make sure your guess is a real molecule.</p>

    <button id="formulaButton" style="text-align: center; display: none" class="center" >Show Chemical Formula</button>
    <div style="padding: 0.6%"></div>
    <div id="formula" style="text-align: center" hidden="hidden"></div>
    <div style="padding: 0.6%"></div>
    <button id="lineButton" style="text-align: center; display: none" class="center">Show Line Structure</button>
    <div style="padding: 0.6%"></div>
    <img id="line" src="" alt="Line Structure of Molecule" class="center" style="width:20vh; border: 2px solid; display: none" >
    <div style="padding: 0.6%;"></div>
    <button id="lewisButton" style="text-align: center; display: none" class="center" >Show Lewis Structure</button>
    <div style="padding: 0.6%"></div>
    <img id="lewis" src="" alt="Lewis Structure of Molecule" class="center" style="width:20vh; border: 2px solid; display: none" >

  </body>
</html>

