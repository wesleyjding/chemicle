<!DOCTYPE html>
<html lang="">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .green { color: green; }
    .yellow { color: goldenrod; }
    .red { color: red; }
    footer {
      background-color: #dddddd;
      color: #000000;
      text-align: center;
      padding: 2px;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
    }
    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    html * {
      font-family: Calibri, Helvetica, Arial, sans-serif;
    }

  </style>
  <head>
    <title>chemicle</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon-light.png" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/x-icon" href="assets/favicon-dark.png" media="(prefers-color-scheme: dark)">
  </head>
  <script type="text/JavaScript">
    // Organic Chemical Type (type, max)
    class oct {
      constructor(type, max, date = null) {
        this._enabled = true;
        this._type = type;
        this._max = max;
        this._date = date;
        this._checkbox = null;
      }

      get enabled() {
        return this._enabled;
      }

      set enabled(value) {
        this._enabled = value;

      }

      disable() {
        this._enabled = false;
        this._checkbox.checked = false;
        setStorage(this._type, false, false);
      }

      get type() {
        return this._type;
      }

      get max() {
        return this._max;
      }

      get date() {
        return this._date;
      }

      get checkbox() {
        return this._checkbox;
      }

      set checkbox(value) {
        this._checkbox = value;
      }

      checkTimeBasedEnable () {
        if(this._date === null) {
          return false;
        }
        let now = Date.now();
        let compareTo = new Date(this._date);
        compareTo.setUTCHours(5);
        return compareTo.getTime() <= now;
      }


    }

    const typeList = [new oct("alkane", 71, "2025-01-01"), new oct("alkene", 33, "2025-02-04"),
      new oct("alkyne", 24, "2025-02-04"), new oct("alcohol", 12, "2025-02-10"),
      new oct("ketone", 13, "2025-02-10"), new oct("carboxylicAcid", 29, "2025-02-12"),
      new oct("aldehyde", 28, "2025-02-10"), new oct("ether", 12, "2025-02-13"),
      new oct("ester", 18, "2025-02-12"), new oct("amine", 32, "2025-02-13"),
      new oct("amide", 12, "2025-02-13"), new oct("nitrile", 4),
      new oct("misc", 7)];

    let idNum;

    let moleculeType;
    let moleculeId;

    let trueMoleculeName;
    let trueMoleculeFormula;

    let doneLoading = false;

    let curSplit = "";
    let curGuessNum = 1;
    let correctGuess = false;

    let settingsButton;
    let settingsCloseButton;
    let settingsDiv;
    let settingsFieldset;
    let settingsLegendDiv;
    let settingsBackgroundDiv;
    let albrittonModeCheck;
    let changedSettings = false;
    let numBoxesChecked = 0;
    let formulaButton;
    let formulaDiv;
    let lineButton;
    let lineImage;
    let lewisButton;
    let lewisImage;
    let solutionButton;
    let solutionDiv;

    document.addEventListener("DOMContentLoaded", async function () {
      checkStorageSettings();
      generateId();
      while (!doneLoading) {
        await new Promise(r => setTimeout(r, 10))
      }
      reloadAssets();
      updateFromStorage();
    });

    function checkStorageSettings() {
      for (let i = 0; i < typeList.length; i++) {
        let obj = typeList[i];
        if(getStorage(obj.type) === "") {
          for (let j = 0; j < typeList.length; j++) {
            let obj2 = typeList[j];
            if(obj2.checkTimeBasedEnable()) {
              obj2.enabled = true;
              setStorage(obj2.type, true, false);
            }
            else {
              obj2.enabled = false;
              setStorage(obj2.type, false, false);
            }
          }
          setStorage("albrittonMode", true, false);
          break;
        }
        else obj.enabled = getStorage(obj.type) === true;
      }

    }

    function generateId(moleculeNum = 1) {

      let totalMax = 0;

      for (let i = 0; i < typeList.length; i++) {
        if (typeList[i].enabled) {
          totalMax += typeList[i].max;
        }
      }

      // Random selection for ids based on date
      function getDailyIdNum(maxValue, moleculeN = 1) {
        function dailyRandom() {
          // Partly generated by ChatGPT

          // Create a Date object for December 1st, 2024, 5:00 AM GMT
          const dec1st5AM = new Date(Date.UTC(2024, 11, 1, 5, 0, 0, 0)); // 11 = December (months are 0-indexed)

          // Get the current date and time in GMT
          const now = new Date();

          // Calculate the difference in milliseconds
          const diffInMs = now - dec1st5AM;

          // Convert milliseconds to days (1 day = 24 * 60 * 60 * 1000 ms)
          let diffInDays = Math.floor(diffInMs / (24 * 60 * 60 * 1000));

          // Deterministic random algorithm
          function random(seed) {
            let t = (seed ^ 0xEFC5DAF8) + (seed << 3);
            t = (t ^ (t >>> 16)) * 0x42EDBF1C;
            t = (t ^ (t >>> 13)) * 0xD9AAB462;
            t = t ^ (t >>> 16);
            return t;
          }

          return Math.abs(random(diffInDays));
        }
        let d = dailyRandom();
        let add = (moleculeN - 1) * Math.floor(Math.pow(d, 0.5));
        return (d + add) % maxValue + 1;
      }

      idNum = getDailyIdNum(totalMax, moleculeNum);
      function checkWithin (max, type) {
        if(idNum <= max) {
          moleculeType = type;
          return true;
        }
        else {
          idNum -= max;
          return false;
        }
      }

      for (let i = 0; i < typeList.length; i++) {
        if (typeList[i].enabled) {
          if (checkWithin(typeList[i].max, typeList[i].type)) {
            break;
          }
        }
      }
      moleculeId = moleculeType + "-" + (idNum).toString().padStart(3, "0");
      console.log(moleculeId);

      fetch("assets/" + moleculeId + "/name.txt")
              .then((res) => res.text())
              .then((text) => {
                const splitString = text.split(", ");
                //console.log(splitString);
                trueMoleculeName = splitString[0].replaceAll("\"", "");
                trueMoleculeFormula = splitString[1].replaceAll("\"", "");
                trueMoleculeFormula = trueMoleculeFormula.replaceAll(/(\d+)/g, '<sub>$1</sub>');
                doneLoading = true;
              })
              .catch((e) => console.error(e));
    }

    function reloadAssets() {
      settingsButton = document.getElementById('settingsButton');
      settingsCloseButton = document.getElementById('settingsCloseButton');
      settingsDiv = document.getElementById('settings');
      settingsFieldset = document.getElementById('settingsFieldset');
      settingsBackgroundDiv = document.getElementById('settingsBackground');

      albrittonModeCheck = document.getElementById('albrittonModeCheck');

      formulaButton = document.getElementById('formulaButton');
      formulaDiv = document.getElementById('formula');

      lineButton = document.getElementById('lineButton');
      lineImage = document.getElementById('line');
      lineImage.src = "assets/" + moleculeId + "/line.png";

      lewisButton = document.getElementById('lewisButton');
      lewisImage = document.getElementById('lewis');
      lewisImage.src = "assets/" + moleculeId + "/lewis.png";

      solutionButton = document.getElementById('solutionButton');
      solutionDiv = document.getElementById('solution');

      function toggleVisibility(button, element, name, isImage = true) {
        if(isImage) {
          if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block'; // Show the image
            if(button != null) {
              button.innerHTML = "Hide " + name;
            }
          } else {
            element.style.display = 'none'; // Hide the image
            if(button != null) {
              button.innerHTML = "Show " + name;
            }
          }
        }
        else {
          if (element.hidden) {
            element.hidden = false; // Show the image
            if(button != null) {
              button.innerHTML = "Hide " + name;
            }
          } else {
            element.hidden = true; // Hide the image
            if(button != null) {
              button.innerHTML = "Show " + name;
            }
          }
        }
      }

      settingsButton.addEventListener('click', () => {
        toggleVisibility(null, settingsDiv, "Settings", false)
        toggleVisibility(null, settingsBackgroundDiv, "SettingsBackground", false)
      });

      settingsCloseButton.addEventListener('click', () => {
        toggleVisibility(null, settingsDiv, "Settings", false)
        toggleVisibility(null, settingsBackgroundDiv, "SettingsBackground", false)
        if(changedSettings) {
          location.reload();
        }
      });

      settingsBackgroundDiv.addEventListener('click', () => {
        toggleVisibility(null, settingsDiv, "Settings", false)
        toggleVisibility(null, settingsBackgroundDiv, "SettingsBackground", false)
        if(changedSettings) {
          location.reload();
        }
      });

      formulaButton.addEventListener('click', () => {
        toggleVisibility(formulaButton, formulaDiv, "Chemical Formula", false)
      });

      lineButton.addEventListener('click', () => {
        toggleVisibility(lineButton, lineImage, "Line Structure")
      });

      lewisButton.addEventListener('click', () => {
        toggleVisibility(lewisButton, lewisImage, "Lewis Structure")
      });

      solutionButton.addEventListener('click', () => {
        toggleVisibility(solutionButton, solutionDiv, "Solution", false)
      });

      albrittonModeCheck.addEventListener('change', () => {
        settingsFieldset.disabled = albrittonModeCheck.checked;
        if(albrittonModeCheck.checked) {
          numBoxesChecked = 0;
          for (let i = 0; i < typeList.length; i++) {
            let obj = typeList[i];
            if(obj.checkTimeBasedEnable()) {
              obj.enabled = true;
              obj.checkbox.checked = true;
              setStorage(obj.type, true, false)
              numBoxesChecked++;
            } else {
              obj.enabled = false;
              obj.checkbox.checked = false;
              setStorage(obj.type, false, false)
            }
          }
          setStorage("albrittonMode", true, false);
        }
        else {
          setStorage("albrittonMode", false, false);
        }
        changedSettings = true;
        setStorage("changedSettings", true, false);
      });

      if(getStorage("albrittonMode")) {
        albrittonModeCheck.checked = true;
        settingsFieldset.disabled = true;
      }

      for (let i = 0; i < typeList.length; i++) {
        let obj = typeList[i];

        settingsLegendDiv = document.getElementById('settingsLegend');

        const newDiv = document.createElement("div");
        const newInput = document.createElement("input");
        newInput.type = "checkbox";
        newInput.id = obj.type + "Check";
        newInput.name = obj.type + "Check";
        newInput.value = obj.type;
        const newLabel = document.createElement("label");
        newLabel.htmlFor = obj.type + "Check";
        newLabel.innerHTML = obj.type.replace(/([A-Z])/g, ' $1') // Add space before each capital letter
                .replace(/^./, match => match.toUpperCase()) // Capitalize the first character
                .trim(); // Remove leading or trailing spaces, if any;
        newDiv.insertBefore(newLabel, null);
        newDiv.insertBefore(newInput, newLabel);
        settingsLegendDiv.parentNode.insertBefore(newDiv, null);
        obj.checkbox = newInput;
        newInput.addEventListener('change', () => {
          if(newInput.checked) {
            obj.enabled = true;
            setStorage(obj.type, true, false);
            numBoxesChecked++;
            changedSettings = true;
            setStorage("changedSettings", true, false);
          }
          else {
            if(numBoxesChecked > 1) {
              obj.enabled = false;
              setStorage(obj.type, false, false);
              numBoxesChecked--;
              changedSettings = true;
              setStorage("changedSettings", true, false);
            }
            else {
              newInput.checked = true;
            }
          }
        });
        if(obj.enabled) {
          newInput.checked = true;
          numBoxesChecked++;
        }
      }
    }

    function updateFromStorage() {
      if(getStorage("changedSettings") === true) {
        setStorage("changedSettings", false, false);
        let i = 1;
        while(getStorage("guess" + i) !== "") {
          removeStorage("guess" + i);
          i++;
        }
        removeStorage("curGuessNum")
      }
      else if (getStorage("curGuessNum") !== "" && getStorage("curGuessNum") > 1) {
        let guessNum = getStorage("curGuessNum");
        for (let i = 1; i < guessNum; i++) {
          curSplit = getStorage("guess" + i).split(',').map(item => item === "" ? "," : item).filter((item, index, array) => item !== ',' || array[index - 1] !== ',');

          //console.log("Updating guess" + i + " to " + curSplit)
          showGuess(true);
        }
      }

    }

    function handleSubmit() {
      const inputText = document.getElementById("guessInput").value;
      const output = splitOrganicString(inputText);
      if (!output) {
        document.getElementById("validWarning").hidden = false;
        return false;
      } else {
        document.getElementById("validWarning").hidden = true;
        curSplit = output;
        showGuess();
        return false;
      }
    }

    function splitOrganicString(input) {
      // Validity Checker and regex generated by ChatGPT, with prompts, fixes and major modifications made by self
      // Define the valid organic chemical parts
      const validParts = [
        "yl", "ane", "ene", "yne",                                                // Suffixes for types of hydrocarbons
        "di", "tri", "tetra",                                                     // Multipliers for side chains
        "iso", "cyclo", "poly", "benz", "form", "acet",                           // Miscellaneous prefixes
        "fluoro", "chloro", "bromo", "iodo",                                      // Halides
        "oxy", "hydroxy", "amine", "oxo",                                         // Functional groups
        "acid", "oate", "anoate", "ether",  "nitrile",                            // More functional groups
        "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", ",", "-", "(", ")",     // Positions (1-9)
        "meth", "eth", "prop", "but", "pent", "hex", "hept", "oct", "non", "dec", // Standard prefixes for chain lengths
        "an", "ol", "one", "al", "oic", "ic", "ate", "a", "en", "yn", "o",        // Misc suffixes for compact spelling
        "tert", "sec",                                                            // Butyl prefixes
      ];

      // Remove whitespace from the input
      input = input.replace(/\s+/g, '').toLowerCase();

      // Result array to store parts
      const result = [];

      // Define a helper function to find the longest matching part from the input
      function matchPart(input) {
        for (let part of validParts) {
          if (input.startsWith(part)) {
            return part;
          }
        }
        return null;  // No valid part found
      }

      // Loop through the input to match parts
      while (input.length > 0) {
        const matchedPart = matchPart(input);

        if (!matchedPart) {
          // No valid part matched; return false
          return false;
        }

        // Add the matched part to the result array
        result.push(matchedPart);

        // Remove the matched part from the beginning of the input
        input = input.slice(matchedPart.length);
      }

      // Return the list of matched parts
      return result;
    }

    function displayColoredText(input, stored, num) {
      // Code generated by ChatGPT, prompt and modifications made by self
      let allCorrect = true;
      let outputDiv;
      try {
        outputDiv = document.getElementById("guess" + num);
      }
      catch(e) {
        console.log("The output div guess + " + num + "does not exist")
        return;
      }
      outputDiv.innerHTML = ''; // Clear any existing content
      const matchedStored = Array(stored.length).fill(false); // Tracks matches in Stored array

      // Step 1: Exact matches (green)
      const results = input.map((item, index) => {
        if (item === stored[index]) {
          matchedStored[index] = true; // Mark exact match in Stored
          return {text: item, colorClass: 'green'};
        }
        return {text: item, colorClass: null}; // Placeholder for later steps
      });

      // Step 2: Non-index matches (yellow)
      results.forEach(result => {
        if (result.colorClass === null) { // Only process items not already green
          const storedIndex = stored.findIndex((item, i) => item === result.text && !matchedStored[i]);
          if (storedIndex !== -1) { // If there's an unmatched stored item
            matchedStored[storedIndex] = true; // Mark this stored item as matched
            result.colorClass = 'yellow';
            allCorrect = false;
          } else {
            result.colorClass = 'red'; // No match found in Stored
            allCorrect = false;
          }
        }
      });

      // Step 3: Display the results
      results.forEach(result => {
        const span = document.createElement('span');
        span.className = result.colorClass;
        span.textContent = result.text + ' ';
        outputDiv.appendChild(span);
      });

      // Step 4: Determine length message
      const lengthMessage = document.createElement('div');
      if (input.length < stored.length) {
        lengthMessage.textContent = 'too short';
      } else if (input.length > stored.length) {
        lengthMessage.textContent = 'too long';
      } else {
        lengthMessage.textContent = 'correct length';
        if(allCorrect) {
          correctGuess = true;
        }
      }
      lengthMessage.setAttribute("style", "padding-bottom: 0.2%");
      outputDiv.appendChild(lengthMessage);
    }

    function showGuess(fromStorage = false){
      displayColoredText(curSplit, splitOrganicString(trueMoleculeName), curGuessNum)
      if(!fromStorage) {
        setStorage("guess" + curGuessNum, curSplit)
      }
      // Clear input box
      document.getElementById("guessInput").value = "";

      if(correctGuess) {
        document.getElementById("guessInput").hidden = true;
        document.getElementById("submitButton").hidden = true;

        const newDiv = document.createElement("div");
        newDiv.id = "congratsMessage";
        newDiv.style.setProperty("text-align", "center");
        newDiv.style.paddingTop = "0.1%";
        const lastDiv = document.getElementById("guess" + curGuessNum);
        lastDiv.parentNode.insertBefore(newDiv, lastDiv.nextSibling);

        const span = document.createElement('span');
        span.className = 'green';
        span.innerHTML = "<b>Correct!</b>";
        newDiv.appendChild(span);
      }
      // Increment guess number
      if(curGuessNum <= 8) {
        curGuessNum++;
        // Add new div
        const newDiv = document.createElement("div");
        newDiv.id = "guess" + curGuessNum;
        newDiv.style.setProperty("text-align", "center");
        const lastDiv = document.getElementById("guess" + (curGuessNum - 1));
        lastDiv.parentNode.insertBefore(newDiv, lastDiv.nextSibling);
      }

      if(!fromStorage) {
        setStorage("curGuessNum", curGuessNum)
      }
      // Show corresponding hint
      if(curGuessNum === 2) {
        formulaButton.style.display = 'block';
        formulaDiv.innerHTML = "Formula = " + trueMoleculeFormula;
      }
      else if(curGuessNum === 3) {
        lineButton.style.display = 'block';
      }
      else if(curGuessNum === 4) {
        lewisButton.style.display = 'block';
      }
      else if(curGuessNum >= 6) {
        solutionButton.style.display = 'block';
        solutionDiv.innerHTML = "Solution = " + trueMoleculeName;
      }
    }

    function setStorage (id, value, expire = true) {
      if(expire) {
        const now = new Date();

        // Create a new Date object for 5 AM today
        let next5AM = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 5, 0, 0, 0));

        // If it's already past 5 AM GMT today, move to the next day
        if (now >= next5AM) {
          next5AM = new Date(next5AM.getTime() + 24 * 60 * 60 * 1000);
        }
        let expires = "expires="+ next5AM.getTime();
        localStorage.setItem(id, value + expires);
      }
      else {
        localStorage.setItem(id, value);
      }
    }

    function removeStorage (id) {
      localStorage.removeItem(id);
    }

    function getStorage (id) {
      let out = localStorage.getItem(id);
      if(!out) {
        return "";
      }

      out = out.split("expires=")
      if(out.length === 1) { // no expiry
        //console.log(id + ": " + out[0] + " (no expiry)");
        if(out[0] === "true") return true;
        else if (out[0] === "false") return false;
        return out[0];
      }
      else {
        let d = new Date(parseInt(out[1]));
        let now = Date.now();
        if(now >= d) {
          localStorage.removeItem(id);
          return "";
        }
        else {
          //console.log(id + ": " + out[0]);
          if(out[0] === "true") return true;
          else if (out[0] === "false") return false;
          return out[0];
        }
      }
    }
  </script>

  <body>
    <h1 style="text-align: center;
      padding: 0.1%; position: static; font-size: xx-large; "><b>chemicle</b></h1>

    <button id="settingsButton">Settings</button>

    <div id="settings" style="position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 300px;
  background: white;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  z-index: 101; /* Higher than overlay */
  padding: 20px;" hidden="hidden">
      <div class="settingsContent">
        <h2>Settings</h2>
        <input type="checkbox" id="albrittonModeCheck" name="albrittonModeCheck" value = "albrittonMode">
        <label for="albrittonModeCheck">Albritton Mode</label>

        <fieldset id="settingsFieldset">
          <legend id="settingsLegend">Type Selection</legend>
        </fieldset>

        <div style="padding: 0.5%"></div>
        <button id="settingsCloseButton">Save and Close</button>
      </div>
    </div>

    <div id="settingsBackground" style="position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 100;" hidden="hidden"></div>

    <div id="guess1" style="text-align: center;"></div>
    <form onsubmit="return handleSubmit();"  style="text-align: center; padding: 1%">
      <label for="guessInput"></label>
      <input type="text"
             id="guessInput"
             name="guessInput"
             required minlength="4"
             maxlength="40"
             size="15">
      <input type="submit"
             id="submitButton"
             name="submitButton"
             value="Submit">
    </form>
    <p id="validWarning" hidden="hidden" style="color:red;text-align: center;">The input is invalid. Please check spelling and make sure your guess is a real molecule.</p>

    <button id="formulaButton" style="text-align: center; display: none" class="center" >Show Chemical Formula</button>
    <div style="padding: 0.6%"></div>
    <div id="formula" style="text-align: center" hidden="hidden"></div>
    <div style="padding: 0.6%"></div>

    <button id="lineButton" style="text-align: center; display: none" class="center">Show Line Structure</button>
    <div style="padding: 0.6%"></div>
    <img id="line" src="" alt="Line Structure of Molecule" class="center" style="width:20vh; border: 2px solid; display: none" >
    <div style="padding: 0.6%;"></div>

    <button id="lewisButton" style="text-align: center; display: none" class="center" >Show Lewis Structure</button>
    <div style="padding: 0.6%"></div>
    <img id="lewis" src="" alt="Lewis Structure of Molecule" class="center" style="width:20vh; border: 2px solid; display: none" >
    <div style="padding: 0.6%;"></div>

    <button id="solutionButton" style="text-align: center; display: none" class="center" >Show Solution</button>
    <div style="padding: 0.6%"></div>
    <div id="solution" style="text-align: center" hidden="hidden"></div>

  </body>
</html>

